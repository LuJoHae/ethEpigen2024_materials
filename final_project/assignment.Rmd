---
title: "Final Project"
subtitle: "Common modes of ERK induction resolve into context-specific signaling via a combination of signal duration and cell type-specific transcriptional repression"
author: "Francesco Biancchi and Lukas Haeuser"
date: "2024/07/02"
---

## Abstract

Perera and Brickman's study delves into the cell-type-specific responses to ERK signaling using ATAC-seq data. They explored how the Fibroblast Growth Factor (FGF) pathway, mediated by ERK, can lead to different outcomes in similar cell types. Their research revealed that while initial ERK responses are common across cell types, they become more refined and specific over time due to interactions with cell-specific gene regulatory networks.
The study found that variations in ERK response are mainly due to transcriptional target suppression, which is linked to reduced chromatin accessibility at regulatory regions. Interestingly, chromatin changes are associated with ERK induction in naïve pluripotency but not in later stages, indicating that chromatin context does not significantly shape the signaling response.
In essence, the researchers suggest that ERK responses start with a common pattern and then adapt to specific lineages by suppressing unique cellular programs and indirectly stimulating available enhancer networks. [1]

## Introduction

During embryonic development, a limited number of extracellular signals guide cell fate decisions by activating specific lineage-specific programs at precise times and locations. The Fibroblast Growth Factor (FGF) signaling through Extracellular signal-Regulated Kinase (ERK) is a prime example, using the same set of kinases to produce varied responses in different tissues. This pathway is crucial for determining cell fate and is frequently mutated in cancer.

In early mammalian development, the embryonic Epiblast segregates into extra-embryonic lineages like the Trophectoderm (TE) and Primitive Endoderm (PrE), with FGF/ERK playing a key role. Initially, it helps segregate outer cells into the TE and inner cells into the Inner Cell Mass (ICM). Just before implantation, FGF/ERK drives the segregation of PrE from the Epiblast by activating ERK in neighboring cells through FGF4 secretion. This process can be manipulated in culture to produce ICMs composed entirely of PrE or Epiblast cells.

ERK inhibition blocks PrE differentiation, allowing for the efficient derivation of mouse Embryonic Stem Cells (mESCs) by expanding peri-implantation Epiblast in the presence of an FGF/ERK signaling inhibitor. Naïve cells exit pluripotency upon ERK stimulation, which suppresses pluripotency factors and activates differentiation programs. Post-implantation Epiblast cells, expanded as pluripotent stem cell cultures, require FGF/ERK for expansion and to prevent differentiation into somatic lineages.

The study developed mouse and cell culture models for time- and cell type-specific ERK activation using intrinsic c-RAF induction and Cre-mediated recombination. These models showed that early ERK signaling responses are conserved across cell types, while later responses vary due to cell type-specific transcriptional repression. The study also revealed that ERK triggers chromatin remodeling in naïve pluripotency and utilizes existing accessible regions in primed pluripotency.

## Summary of Paper's Results

Researchers developed a method to study how mouse pre- and post-implantation epiblast cells respond to ERK signaling, both in vivo and in vitro. They used a genetic model with a tamoxifen-activated c-RAF kinase to precisely control ERK activation. For in vivo studies, they created a stable mouse line called CRAFR26, which allowed lineage-specific ERK activation and visualization using a tagged reporter.

To verify their system, they bred CRAFR26 mice with Sox2Cre mice and observed ERK activation in embryos. In vitro, they created a cell line that showed uniform ERK induction after tamoxifen treatment, which could be reversed by a MEK inhibitor. They confirmed that ERK signaling originated from the exogenous construct and maintained ESC identity during ERK induction.

ERK signaling triggered an early common transcriptional response and later activated cell-specific programs. By differentiating ESCs into RSCs and EpiLCs, they mapped the transcriptional response to ERK using RNA sequencing. They found that ERK suppressed pluripotency genes in naïve ESCs but induced them in EpiLCs, aligning with FGF's role in supporting primed pluripotency. ERK-mediated gene repression was cell type-specific, while activation was more widespread.

The study highlighted that gene repression by ERK is crucial for specific responses. They identified genes related to placenta development and angiogenesis being suppressed in RSCs and EpiLCs, respectively. They also sequenced the transcriptome of in vivo epiblast cells before and after ERK activation, finding that in vitro adaptation primarily affected gene expression but still distinguished naïve from primed states.

Using ATAC-seq, they assessed changes in chromatin accessibility upon ERK induction. They found that ERK-activated enhancers became more accessible across cell types, while ERK-repressed enhancers showed cell type-specific changes. ERK-canonical transcription factors increased binding upon ERK induction, suggesting shared activation mechanisms but cell type-specific repression.

Overall, the study demonstrated that pre-existing chromatin states significantly impact cell type-specific responses to ERK signaling, with ERK exploiting preconfigured targets in EpiLCs and driving chromatin rearrangement in naïve ESCs.


## Data Analysis on ATAC-seq Data by the Paper

The raw sequencing reads were processed with bcl2fastq and trimmed using cutadapt to remove adapters. These reads were then aligned to the mm10 genome using bowtie2. To ensure high-quality data, mitochondrial DNA (ChrM), duplicate reads, and reads in blacklisted regions were excluded. Peaks were identified using macs2 with broad peak calling parameters, and consensus peaks for each condition were defined from two replicates using the DiffBind package.

Promoter regions were excluded using the Eukaryotic Promoter Database to focus on relevant regions. Reads within the defined peaks were counted using subread featureCounts, creating a count table for differential enrichment analysis. DESeq2 was used to calculate the Log2 Fold Change (log2FC) enrichment per peak before and after ERK induction, with significant changes defined as abs(log2FC) > 1.5 and padj < 0.01. Overlapping peaks between conditions were identified using bedtools intersect.

Motif analysis and peak annotation were conducted with HOMER, including motif finding and peak annotation. Data visualization was done through heatmaps and profile plots using deeptools. TF footprinting and differential binding scores were determined using TOBIAS, with corrections and scoring performed on merged bam files from both replicates against all consensus peaks. BINDetect was used on the peak set of interest, and TF binding motifs for footprinting analysis were sourced from the latest version of JASPAR.

## Our Data Analysis

We downloaded the ATAC-seq counts from GEO. Then we wanted to produce some enrichment plots, but stumbled upon a bug we could not resolve. Same happened for the differential analysis.

## Code
```{r, eval=FALSE}
# Install BiocManager if not already installed
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

# Update all Bioconductor packages
BiocManager::install(version = "3.18")  # Use the latest Bioconductor version

# Specifically update IRanges and GenomicRanges
BiocManager::install(c("IRanges", "GenomicRanges"))
```

### Load the libraries

```{r, eval=FALSE}
# Load necessary libraries
suppressPackageStartupMessages({
  library(epiwraps)
  library(AnnotationHub)
  library(MotifDb)
  library(memes)
  library(universalmotif)
  library(ensembldb)
  library(ggplot2)
  library(motifmatchr)
  library(SummarizedExperiment)
  library(sechm)
  library(BiocParallel)
  library(chromVAR)
  library(limma)
  library(GenomicRanges)
  library(rtracklayer)
  library(csaw)
  library(EnrichedHeatmap)
  library(TFBSTools)
  library(BSgenome)
  library(BSgenome.Mmusculus.UCSC.mm10)
  library(edgeR)
  library(pheatmap)
  library(ComplexHeatmap)
})

```


```{r, eval=FALSE}
ah <- AnnotationHub::AnnotationHub()
```

### Download ATAC-seq data

```{r, eval=FALSE}
download.file(
  "https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM8111nnn/GSM8111840/suppl/GSM8111840%5FESC%5F0h%5F1.bw",
  "esc_0h_1.bw"
)
download.file(
  "https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM8111nnn/GSM8111841/suppl/GSM8111841%5FESC%5F0h%5F2.bw", 
  "esc_0h_2.bw"
)
download.file(
  "https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM8111nnn/GSM8111842/suppl/GSM8111842%5FESC%5F4h%5F1.bw",
  "esc_4h_1.bw"
)
download.file(
  "https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM8111nnn/GSM8111843/suppl/GSM8111843%5FESC%5F4h%5F2.bw",
  "esc_4h_2.bw"
)
download.file(
  "https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM8111nnn/GSM8111844/suppl/GSM8111844%5FRSC%5F0h%5F1.bw",
  "rsc_0h_1.bw"
)
download.file(
  "https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM8111nnn/GSM8111845/suppl/GSM8111845%5FRSC%5F0h%5F2.bw",
  "rsc_0h_2.bw"
)
download.file(
  "https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM8111nnn/GSM8111846/suppl/GSM8111846%5FRSC%5F4h%5F1.bw",
  "rsc_4h_1.bw"
)
download.file(
  "https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM8111nnn/GSM8111847/suppl/GSM8111847%5FRSC%5F4h%5F2.bw",
  "rsc_4h_2.bw"
)
download.file(
  "https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM8111nnn/GSM8111848/suppl/GSM8111848%5FEpiLC%5F0h%5F1.bw",
  "epilc_0h_1.bw"
)
download.file(
  "https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM8111nnn/GSM8111849/suppl/GSM8111849%5FEpiLC%5F0h%5F2.bw",
  "epilc_0h_2.bw"
)
download.file(
  "https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM8111nnn/GSM8111850/suppl/GSM8111850%5FEpiLC%5F4h%5F1.bw",
  "epilc_4h_1.bw"
)
download.file(
  "https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM8111nnn/GSM8111851/suppl/GSM8111851%5FEpiLC%5F4h%5F2.bw",
  "epilc_4h_2.bw"
)

```

### Process BigWig Files

```{r, eval=FALSE}
# Function to import a limited number of very small chunks from a BigWig file
import_bigwig_sample <- function(file, sample_size = 10, chunk_size = 1000) {
  bw <- BigWigFile(file)
  seqinfo <- seqinfo(bw)
  chr_lengths <- seqlengths(seqinfo)
  
  sample_regions <- GRanges()
  
  for (chr in names(chr_lengths)) {
    cat("Processing chromosome:", chr, "\n")
    chr_length <- chr_lengths[chr]
    chunk_indices <- seq(1, chr_length, by = chunk_size)
    selected_chunks <- sample(chunk_indices, min(length(chunk_indices), sample_size))
    
    for (start in selected_chunks) {
      end <- min(start + chunk_size - 1, chr_length)
      region <- GRanges(seqnames = chr, ranges = IRanges(start = start, end = end))
      sample_regions <- c(sample_regions, region)
    }
  }
  
  import.bw(file, which = sample_regions)
}

# List all BigWig files
bw_files <- list.files(path = "BW_Files", pattern = "\\.bw$", full.names = TRUE)

# Import a random sample of regions from each BigWig file
all_tracks <- list()
for (bw_file in bw_files) {
  cat("Processing file:", bw_file, "\n")
  sample_data <- tryCatch({
    import_bigwig_sample(bw_file, sample_size = 5, chunk_size = 500)  # Adjust sample_size and chunk_size as needed
  }, error = function(e) {
    cat("Error in processing file:", bw_file, ":", e$message, "\n")
    NULL
  })
  if (!is.null(sample_data)) {
    all_tracks[[bw_file]] <- sample_data
  }
}

# Combine tracks into a single GRanges object
combined_tracks <- do.call(c, all_tracks)

```

### Create Signal Matrix and Perform Clustering

```{r, eval=FALSE}
# Function to create a signal matrix from the sampled tracks
create_signal_matrix <- function(bw_files, combined_tracks) {
  signal_matrix <- sapply(bw_files, function(bw_file) {
    bw_data <- import.bw(bw_file, which = combined_tracks)
    scores <- rep(0, length(combined_tracks))
    overlaps <- findOverlaps(combined_tracks, bw_data)
    scores[queryHits(overlaps)] <- score(bw_data)[subjectHits(overlaps)]
    return(scores)
  })
  colnames(signal_matrix) <- basename(bw_files)
  return(signal_matrix)
}

signal_matrix <- create_signal_matrix(bw_files, combined_tracks)

# Create SummarizedExperiment object
se <- SummarizedExperiment(assays = SimpleList(counts = signal_matrix), rowRanges = combined_tracks)

# Normalize the signal matrix using edgeR
dge <- DGEList(counts = assay(se))
dge <- calcNormFactors(dge)
normalized_counts <- cpm(dge, normalized.lib.sizes = TRUE)

# Perform clustering
dist_matrix <- dist(t(normalized_counts))  # Calculate distance matrix
clustering <- hclust(dist_matrix)  # Perform hierarchical clustering

# Plot heatmap of the clustered data
pheatmap(normalized_counts, cluster_rows = clustering, cluster_cols = TRUE, show_rownames = FALSE)

```

### chromVAR Motif Accessibility Analysis

```{r, eval=FALSE}
# Add GC bias
se <- chromVAR::addGCBias(se, genome = BSgenome.Mmusculus.UCSC.mm10)

# Get background peaks
bg <- chromVAR::getBackgroundPeaks(se, niterations = 1000)

# Load motifs from MotifDb
motifs <- query(MotifDb, c("HOCOMOCOv10", "Mmusculus"))
motifs <- do.call(TFBSTools::PWMatrixList, setNames(universalmotif::convert_motifs(motifs, class = "TFBSTools-PWMatrix"), mcols(motifs)$geneSymbol))

# Match motifs to peaks
motif_matches <- motifmatchr::matchMotifs(motifs, subject = rowRanges(se), genome = BSgenome.Mmusculus.UCSC.mm10)

# Compute deviations
dev <- chromVAR::computeDeviations(object = se, annotations = motif_matches, background_peaks = bg)

# Save chromVAR deviations
saveRDS(dev, file = "chromVAR_deviations.rds")

# Load chromVAR deviations
deviations_matrix <- assays(dev)$deviations

# Plot heatmap for top motifs
top_motifs <- head(rownames(deviations_matrix), 20)  # Select top 20 motifs for visualization

# Create heatmap for chromVAR results
pheatmap(deviations_matrix[top_motifs, ], cluster_rows = TRUE, cluster_cols = TRUE, show_rownames = TRUE)

```

### Final processing

```{r, eval=FALSE}
# Load necessary libraries
library(GenomicRanges)
library(rtracklayer)
library(SummarizedExperiment)
library(ComplexHeatmap)
library(edgeR)

# Function to create a signal matrix
create_signal_matrix <- function(bw_files, union_peaks) {
  signal_matrix <- lapply(bw_files, function(bw_file) {
    message("Processing file: ", bw_file)
    bw_data <- import.bw(bw_file, which = union_peaks)
    scores <- rep(0, length(union_peaks))
    overlaps <- findOverlaps(union_peaks, bw_data)
    scores[queryHits(overlaps)] <- score(bw_data)[subjectHits(overlaps)]
    return(scores)
  })
  signal_matrix <- do.call(cbind, signal_matrix)
  colnames(signal_matrix) <- basename(bw_files)
  return(signal_matrix)
}

# Create signal matrix
signal_matrix <- create_signal_matrix(bw_files, union_peaks)

# SummarizedExperiment object
se <- SummarizedExperiment(assays = SimpleList(counts = signal_matrix), rowRanges = union_peaks)

# Normalize the signal matrix using edgeR
dge <- DGEList(counts = assay(se))
dge <- calcNormFactors(dge)
normalized_counts <- cpm(dge, normalized.lib.sizes = TRUE)

# Save the normalized signal matrix for further analysis
saveRDS(normalized_counts, file = "normalized_signal_matrix.rds")

# ---- Proceed with chromVAR Analysis ----

# Load necessary libraries
library(chromVAR)
library(MotifDb)
library(BSgenome.Mmusculus.UCSC.mm10)

# Load the normalized signal matrix and SummarizedExperiment object
se <- SummarizedExperiment(assays = SimpleList(counts = normalized_counts), rowRanges = union_peaks)

# Load the motifs
motifs <- query(MotifDb, c("HOCOMOCOv10", "Mmusculus"))

# Ensure motif names are unique
motifs <- do.call(TFBSTools::PWMatrixList, setNames(universalmotif::convert_motifs(motifs, class="TFBSTools-PWMatrix"), mcols(motifs)$geneSymbol))

# Load the genome
genome <- BSgenome.Mmusculus.UCSC.mm10

# Add GC bias
se <- chromVAR::addGCBias(se, genome=genome)

# Get background peaks
bg <- chromVAR::getBackgroundPeaks(se, niterations=1000)

# Match motifs to peaks
moi <- motifmatchr::matchMotifs(motifs, subject=rowRanges(se), genome=genome)

# Compute deviations
dev <- chromVAR::computeDeviations(object=se, annotations=moi, background_peaks=bg)

# Save chromVAR deviations
saveRDS(dev, file = "chromVAR_deviations.rds")

# ---- Heatmap Visualization ----

# Load chromVAR deviations
deviations_matrix <- assays(dev)$deviations

# Heatmap for top motifs
top_motifs <- head(rownames(deviations_matrix), 20)  # Select top 20 motifs for visualization

Heatmap(deviations_matrix[top_motifs, ], name = "Deviation Z-Score", 
        cluster_rows = TRUE, cluster_columns = TRUE,
        show_row_names = TRUE, show_column_names = TRUE,
        col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")))

```

### Cluster Genomic Signals in the Union of Peaks

```{r, eval=FALSE}
# Load necessary libraries
library(GenomicRanges)
library(SummarizedExperiment)
library(edgeR)
library(pheatmap)

# Function to create a signal matrix
create_signal_matrix <- function(bw_files, combined_tracks) {
  signal_matrix <- sapply(bw_files, function(bw_file) {
    bw_data <- import.bw(bw_file, which = combined_tracks)
    scores <- rep(0, length(combined_tracks))
    overlaps <- findOverlaps(combined_tracks, bw_data)
    scores[queryHits(overlaps)] <- score(bw_data)[subjectHits(overlaps)]
    return(scores)
  })
  colnames(signal_matrix) <- basename(bw_files)
  return(signal_matrix)
}

# Create signal matrix
signal_matrix <- create_signal_matrix(bw_files, combined_tracks)

# Create SummarizedExperiment object
se <- SummarizedExperiment(assays = SimpleList(counts = signal_matrix), rowRanges = combined_tracks)

# Normalize the signal matrix using edgeR
dge <- DGEList(counts = assay(se))
dge <- calcNormFactors(dge)
normalized_counts <- cpm(dge, normalized.lib.sizes = TRUE)

# Perform clustering
dist_matrix <- dist(t(normalized_counts))  # Calculate distance matrix
clustering <- hclust(dist_matrix)  # Perform hierarchical clustering

# Plot heatmap of the clustered data
pheatmap(normalized_counts, cluster_rows = clustering, cluster_cols = TRUE, show_rownames = FALSE)

```

## Encounterd problems:

### Direct Import with rtracklayer

**Approach:**
Attempted to import BigWig files directly into R using the rtracklayer package.
Aimed to process the entire file or large chunks of the file in one go.  

**Issues Encountered:**  
Encountered errors such as Too many pushAbortHandlers, can only handle 11 and UCSC library operation failed.
These errors indicated limitations in the handling capacity of the library for large files.

### Subsetting Data in Smaller Chunks

**Approach:**  
Defined a function to import random smaller chunks of regions from BigWig files using rtracklayer.
Processed each file in smaller chunks sequentially and combined the results.

**Issues Encountered:**  
Even with reduced chunk sizes, the Too many pushAbortHandlers error persisted due to the size and complexity of the files.
The approach was still too memory-intensive.

### Converting BigWig to BedGraph Using UCSC Utilities

**Approach:**  
Used the bigWigToBedGraph utility from UCSC tools to convert BigWig files to BedGraph format.
Intended to process BedGraph files in R, which are simpler and more manageable:

- Download and install bigWigToBedGraph.
- Convert BigWig files to BedGraph format using a shell script.
- Import BedGraph files into R and process them.

**Issues Encountered:**  
Difficulty in properly setting up the environment and paths on macOS.
The conversion and subsequent processing steps were not fully verified due to setup issues.

### Processing Even Smaller Subsets Sequentially

**Approach:**  
Further reduced the sample size and chunk size for importing data from BigWig files.
Defined a function to import very small random samples of regions from each BigWig file.

**Issues Encountered:**  
Same as beforehand.


## Summary of Paper's Discussion

The central question in developmental biology is how a single signal can produce different outcomes depending on the cellular or tissue context. FGF/ERK is crucial for processes like proliferation, survival, and differentiation across various tissues. Understanding how it achieves this regulatory diversity through conserved immediate early transcription factors (TFs) is complex.

Researchers developed a tool for precise, uniform ERK activation both in vivo and in vitro to study context-dependent cellular responses. They found that context-dependent transcription relies on ERK's ability to suppress cell type-specific transcription, overcoming heterogeneity and feedback inhibition.

Their findings indicate that ERK-mediated activation is driven by canonical ETS–AP-1 TFs, while cell type-specific repression occurs without significant reduction in lineage-specific TF binding. In naïve ESCs, ERK induction reduces accessibility in regions with TCF motifs, suggesting an FGF-dependent change in WNT activity. In the Epiblast lineage, ERK represses naïve ESC enhancers with POU/OCT motifs, aiding the transition to primed pluripotency. In EpiLCs, where FGF/ERK supports self-renewal, FOX factors involved in gastrulation are identified.

The study aligns FGF/ERK's role in neural differentiation with default neural induction. ERK's context-dependent repression promotes endoderm differentiation with WNT signaling but Epiblast differentiation without it. POU motifs in ERK-repressed RSC enhancers suggest FGF/ERK represses overlapping pluripotent/neural programs regulated by POU and SOX proteins, maintaining Epiblast identity over anterior neural differentiation.

Regulatory responses are largely about repression. Immediate early genes activated by ERK are context-independent, while repression depends on the target cell type's regulatory program. Activation is more widespread, relying on conserved factors, but time and duration eventually change the transcriptional program. This interaction between common immediate early TFs and cell type-specific factors creates unique responses. For instance, pluripotency genes in EpiLCs are induced only after four hours, likely not directly regulated by ETS–AP-1 factors.

The study shows that ubiquitous factors can act similarly in different cell types, but their ability to induce transcription doesn't always correlate with chromatin structure changes. The cis-regulatory strategy for generating transcriptional output requires remodeling in naïve ESCs but not in EpiLCs, indicating different strategies depending on context. This adaptability to cellular context and chromatin is seen in other developmental settings, though mechanisms remain unclear.

Their data provides a framework for signal-dependent context specificity, where transcriptional and chromatin changes in response to ERK are more universal in activation than repression. Context-dependent repression mainly involves deactivating enhancers, leaving cell-specific TFs bound to targets. Activation of ERK-responsive genes relies on commonly activated genes triggered by ETS–AP-1 factors, propagated through existing cell-specific states. Whether activation involves chromatin remodeling depends on prebound core TFs, making cells flexible to respond to signaling and differentiate in specific contexts.

## Conclusion

Despite our best efforts, we were unable to complete the research project due to significant issues with the provided bigwig files and the associated code. These technical challenges hindered our ability to process and analyze the data effectively, ultimately preventing us from drawing meaningful conclusions.

## References
[1] Perera, Marta, and Josh Brickman. "Common modes of ERK induction resolve into context specific signalling via a combination of signal duration and cell type specific transcriptional repression." bioRxiv (2024): 2024-02.